{% extends 'base.html' %}
{% load humanize %}
{% load convert_tags %}

{% block title %} | Posts{% endblock%}

{% block content %}
<section class="fluid-container landing-item gray-bg-color">
    {% block header %}
    <h1 class="pt-5 ps-5 dark-color">Posts:</h1>
    {% endblock %}
    <!-- Search form  -->
    <div class="container pt-5">
        <form action="{% url 'post:blog' %}" method="GET">
            <div class="row" class="form-field">
                <div class="form-floating col-12 col-md-6 pb-2">
                  <input name="search" type="text" class="form-control" id="search_field"
                         placeholder="Digite sua pesquisa aqui"
                         aria-label="Campo para pesquisa"
                         value="{{ get_request.search.0 }}">
                  <label for="search_field">Buscar por</label>
                </div>

                <div class="form-floating col-12 col-md-3 pb-2">
                    <select name="category" class="form-select" id="category_field" aria-label="Categoria para pesquisa">
                        <option value="0">Todas</option>
                        {% for category in categories %}
                        <option value="{{ category.pk }}" {% if category.pk == get_request.category.0 %}selected{% endif %}>
                            {{ category.title }}
                        </option>
                        {% endfor %}
                    </select>
                    <label for="category_field">Categoria</label>
                </div>

                <div class="form-floating col-12 col-md-3 pb-2">
                    <select name="order_by" class="form-select" id="order_by_field" aria-label="Ordenar pesquisa por">
                        <option value="publicacao" {% if get_request.order_by.0 == "publicacao" %}selected{% endif %}>Data de publicação</option>
                        <option value="avaliacao" {% if get_request.order_by.0 == "avaliacao" %}selected{% endif %}>Avaliação</option>
                    </select>
                    <label for="order_by_field">Ordenar por</label>
                </div>
            </div>

            <div class="row">
                <div class="col-12 mt-2 text-end">
                    <input class="button-format" type="submit" value="Pesquisar">
                </div>
            </div>
        </form>
    </div>

    <!-- List of posts -->
    <div id="content" class="container card-columns pt-3 pb-3">
        {% for post in posts %}
        <article class="card dark-bg-color light-color">
            {% if post.image %}
            <a href="{% url 'post:post' post.pk %}">
                <img src="{{ post.image.url }}" alt="{{ post.title }}" class="card-img-top">
            </a>
            {% endif %}
            <div class="card-body">
                <h1 class="h3">{{ post.title }}</h1>
                <p class="d-flex justify-content-around">
                    <small>
                        {{ post.ratting|to_int }} <i class="bi bi-star-fill text-warning"></i>
                    </small>

                    <small>
                        {{ post.views }} <i class="bi bi-eye-fill"></i>
                    </small>

                    <small>
                        {{ post.comments }} <i class="bi bi-chat-left-text-fill"></i>
                    </small>
                </p>
                <p>{{ post.excerpt }}</p>
                <p class="text-end">
                    <small>
                        {{ post.published_date|naturalday|title }}
                    </small>
                </p>
            </div>
            <div class="card-footer text-end">
                <a href="{% url 'post:post' post.pk %}">
                    <button class="gray-bg-color dark-color"><strong>Acessar</strong></button>
                </a>
            </div>
        </article>
        {% endfor %}
    </div>
</section>

{% block popup %}{% endblock %}

{% endblock %}

{% block scripts %}

<script>
    localStorage.setItem('offset', {{ posts.count }});

    function userReachedBottom() {
      const scrollPosition = window.scrollY + window.innerHeight;
      const documentHeight = document.documentElement.offsetHeight - 600;
      return scrollPosition >= documentHeight;
    }

    window.addEventListener('scroll', () => {
        if (userReachedBottom()) {
            let offset = localStorage.getItem('offset');
            $.ajax({
                url: '{% url 'post:load_more_content' %}',
                data: {
                    'offset': offset,
                    'category': '{{ get_request.category.0 }}',
                    'search': '{{ get_request.search.0 }}',
                    'order_by': '{{ get_request.order_by.0 }}'
                },
                success: function(posts) {
                    if (posts.length > 0) {
                        for (var i = 0; i < posts.length; i++) {
                            var articleElement = $('<article class="card dark-bg-color light-color"></article>');

                            if (posts[i].image) {
                                var imgElement = $('<a href="' + '/post/' + posts[i].pk + '"><img src="' + posts[i].image + '" alt="' + posts[i].title + '" class="card-img-top"></a>');
                                articleElement.append(imgElement);
                            }

                            var cardBodyElement = $('<div class="card-body"></div>');

                            cardBodyElement.append('<h1 class="h3">' + posts[i].title + '</h1>');
                            cardBodyElement.append('<p class="d-flex justify-content-around"><small>' + posts[i].ratting + ' <i class="bi bi-star-fill text-warning"></i></small><small>' + posts[i].views + ' <i class="bi bi-eye-fill"></i></small><small>' + posts[i].comments + ' <i class="bi bi-chat-left-text-fill"></i></small></p>');
                            cardBodyElement.append('<p>' + posts[i].excerpt + '</p>');
                            cardBodyElement.append('<p class="text-end"><small>' + posts[i].published_date + '</small></p>');

                            articleElement.append(cardBodyElement);

                            var cardFooterElement = $('<div class="card-footer text-end"><a href="/post/' + posts[i].pk + '"><button class="gray-bg-color dark-color"><strong>Acessar</strong></button></a></div>');

                            articleElement.append(cardFooterElement);

                            $('#content').append(articleElement);
                        }
                        offset = parseInt(offset) + posts.length;
                    }
                    localStorage.setItem('offset', offset);
                }
            });
        }
    });
</script>

{% endblock %}
